<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>Image editor</title>
<link rel="stylesheet" type="text/css" href="../../styles/filemanager.css" />
<link rel="stylesheet" type="text/css" href="../../scripts/jquery.imgareaselect/css/imgareaselect-animated.css" />
<link rel="stylesheet" type="text/css" href="../../plugins/image-editor/style.css" />
</head>
<body>

<!-- upload form -->
<form id="save-image" method="get">
    <input type="hidden" id="path" name="path" value="" />
    <input type="hidden" name="width" value="" />
    <input type="hidden" name="height" value="" />
    <input type="hidden" name="x1" value="" />
    <input type="hidden" name="y1" value="" />
    
    <!-- edit options -->
    <div>
        <label>Options</label>
        <input type="radio" name="mode" value="crop" id="crop" checked="checked" /> <label for="crop" title="Crop image">Crop</label>
        <input type="radio" name="mode" value="resize" id="resize" /> <label for="resize" title="Resize image dimensions">Resize</label>
        <button id="save">Save</button>
    </div>
</form>

<!-- resize options -->
<div id="resize-options">
    <label>Dimensions</label>
    <input type="text" id="changeWidth" name="resize-width" /> x <input type="text" id="changeHeight" name="resize-height" /> px
</div>

<div id="help">
    Make your selection and press "Save".
</div>

<!-- photo -->
<div>
    <img id="photo" src="" alt="image" />
</div>

<script type="text/javascript" src="../../scripts/jquery-1.6.1.min.js"></script>
<script type="text/javascript" src="../../scripts/jquery.form-2.63.js"></script>
<script type="text/javascript" src="../../scripts/jquery.impromptu-3.1.min.js"></script>
<script type="text/javascript" src="../../scripts/jquery.imgareaselect/jquery.imgareaselect.min.js"></script>
<script type="text/javascript" src="scripts.js"></script>
<script type="text/javascript" src="../../scripts/filemanager.config.js"></script>

<script type="text/javascript">
(function ($) {
    // Sets image path.
    var imgPath = $.urlParam('path');

    $(document).ready(function () {
        /**********************************************************
        Default settings
        **********************************************************/
        jQuery.ajaxSetup({
            // Disable caching of AJAX responses 
            cache: false
        });

        // cosmetic tweak for buttons
        $('button').wrapInner('<span></span>');

        // disable save button
        $('#save').attr('disabled', true);

        // set image source
        $('#photo').attr('src', imgPath);

        // set image path
        $('#path').val(imgPath);

        // default setting edit actions
        $.setFormAction();

        /**********************************************************
        Default variable
        **********************************************************/
        var originalImageWidth = 0,
            originalImageHeight = 0;

        // work around getting images sizes
        setTimeout(function () {
            originalImageWidth = $("#photo").width(),
            originalImageHeight = $("#photo").height();
        }, 100);

        /**********************************************************
        Options
        **********************************************************/
        $("input:radio[name=mode]").click(function () {
            var mode = $(this).val();

            if (mode == "crop") {
                // activate image crop
                $('img#photo').imgAreaSelect({
                    enable: true
                });

                // undo resize settings
                $.resizeInputs(false, originalImageWidth, originalImageHeight);

                // resize options (hidden)
                $("#resize-options").slideUp();
            } else {
                // activate image resize
                $('img#photo').imgAreaSelect({
                    disable: true,
                    hide: true
                });

                // undo resize settings
                $.resizeInputs(true, originalImageWidth, originalImageHeight);

                // resize options (visible)
                $("#resize-options").slideDown();
            }

            // disable save button
            $('#save').attr('disabled', true);
        });


        /**********************************************************
        Crop "editor"
        **********************************************************/
        // start up image (crop) editor
        $('img#photo').imgAreaSelect({
            handles: true,
            onSelectEnd: function (img, selection) {
                $('input[name=x1]').val(selection.x1);
                $('input[name=y1]').val(selection.y1);
                $('input[name=width]').val(selection.width);
                $('input[name=height]').val(selection.height);

                $('#save').attr('disabled', false);
            }
        });

        // save crop
        $('#save-image').ajaxForm({
            //target: '#uploadresponse',
            beforeSubmit: function (arr, form, options) {
                // disable button
                $('#save').attr('disabled', true);
                $('#save span').addClass("loading").text("Saving image");
            },
            success: function (result) {
                var data = jQuery.parseJSON(result);

                alert(data);

                if (data['Code'] == 0) {
                    // refresh opener window
                    window.opener.$.getFolderInfo(data['Path'].substr(0, data['Path'].lastIndexOf('/') + 1));

                    // close popup
                    window.close();
                } else {
                    // display error
                    $.prompt(data['Error']);

                    // activate button
                    $('#save').removeAttr('disabled');
                    $('#save span').removeClass("loading").text("Save");
                }
            }
        });
    });

})(jQuery);
</script>
</body>
</html>
